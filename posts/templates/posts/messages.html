{% extends 'posts/base.html' %}
{% load post_extras %}
{% load static %}
{% block title %}Your Messages On Privalise!, Where Everything Is Awesome{% endblock title %}
{% block content %}
<script src="{% static 'js/libraries/jsencrypt.min.js' %}"></script>
<script src="{% static 'js/libraries/jquery.min.js' %}"></script>
<script src="{% static 'js/libraries/openpgp.js' %}"></script>
<script type="text/javascript">
    function getCookie(cname) 
    {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
            c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    
    function decryptkey(password) 
    {
        var pki = forge.pki;
        var privateKey = pki.decryptRsaPrivateKey(`{{privkey}}`, password);
        var pem = pki.privateKeyToPem(privateKey);
        return pem
    }
    // var plainprivkey = decryptkey(getCookie('key'));
    // var iv = `{{iv}}`;
    // var sharedkey = `{{sharedkey}}`;
    // var decryptsharedkey = new JSEncrypt();
    // decryptsharedkey.setPrivateKey(plainprivkey);
    // var uncryptedsharedkey = decryptsharedkey.decrypt(sharedkey);
    // var uncryptediv = decryptsharedkey.decrypt(iv);
    // function decryptmsgs(msg) 
    // {  
    // }
    async function encmesg() 
    {
        const message = await openpgp.createMessage({ text: document.getElementById('contentmsg').value }); 
        const encrypted = await openpgp.encrypt({
            message,
            passwords: [getCookie('key')],
            config: { preferredCompressionAlgorithm: openpgp.enums.compression.zlib }
        });
        // console.log(encrypted);
        document.getElementById('encryptedmsgs').value = await encrypted;
        document.msgform.submit();
    }
    async function decryptmsgs(msg, id) {
        const message = await openpgp.readMessage({
            armoredMessage: msg 
        });
        const decrypted = await openpgp.decrypt({
            message,
            passwords: [getCookie('key')], // optional
            config: { preferredCompressionAlgorithm: openpgp.enums.compression.zlib }
        });
        console.log(decrypted.data);
        document.getElementById(id).innerHTML = await decrypted.data;
    }
</script>
<div class="w-100">
    {% for msg in msgs %}
        <script>decryptmsgs(`{{msg.msg}}`, `{{msg.id}}`)</script>
        <p id="{{msg.id}}"></p>
    {% endfor %}
</div>
<form method="POST" name="msgform" class="w-100">
    {% csrf_token %}
    <div class="input-group mb-3" style="margin: 0 auto;">
        <input type="text" autofocus name="msgcontent" class="form-control form-control-lg" placeholder="Type Your Message" id='contentmsg'>
        <textarea id="encryptedmsgs" name="encryptedmsg" style="display: none;"></textarea>
        <button class="btn btn-primary"  onclick="encmesg()" type="submit" id='sendmsg'><i class="fas fa-paper-plane"></i></button>
    </div>
</form>
<script>
</script>
{% endblock %}