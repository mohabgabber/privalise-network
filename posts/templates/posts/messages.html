{% extends 'posts/base.html' %}
{% load post_extras %}
{% load static %}
{% block title %}Your Messages On Privalise!, Where Everything Is Awesome{% endblock title %}
{% block content %}
<script src="{% static 'js/libraries/jsencrypt.min.js' %}"></script>
<script src="{% static 'js/libraries/jquery.min.js' %}"></script>
<script src="{% static 'js/libraries/openpgp.js' %}"></script>
<script type="text/javascript">
    function getCookie(cname) 
    {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
            c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    
    function decryptkey(password) 
    {
        var pki = forge.pki;
        var privateKey = pki.decryptRsaPrivateKey(`{{privkey}}`, password);
        var pem = pki.privateKeyToPem(privateKey);
        return pem
    }
    // var plainprivkey = decryptkey(getCookie('key'));
    // var iv = `{{iv}}`;
    // var sharedkey = `{{sharedkey}}`;
    // var decryptsharedkey = new JSEncrypt();
    // decryptsharedkey.setPrivateKey(plainprivkey);
    // var uncryptedsharedkey = decryptsharedkey.decrypt(sharedkey);
    // var uncryptediv = decryptsharedkey.decrypt(iv);
    // function decryptmsgs(msg) 
    // {  
    // }
    async function encmesg() 
    {
        const message = await openpgp.createMessage({ text: document.getElementById('contentmsg').value }); 
        const encrypted = await openpgp.encrypt({message, passwords: [getCookie('key')],});
        // console.log(await encrypted);
        document.getElementById('encryptedmsgs').value = await encrypted;
        document.msgform.submit();
    }
    async function decryptmsgs(msg, id) {
        const message = await openpgp.readMessage({
            armoredMessage: msg 
        });
        const decrypted = await openpgp.decrypt({
            message,
            passwords: [getCookie('key')],
        });
        console.log(decrypted.data);
        document.getElementById(id).innerHTML = await decrypted.data;
    }
</script>
<div class="w-100 content">
    <div class="w-75 mx-auto gap-3">
        {% for msg in msgs %}
            <script>decryptmsgs(`{{msg.msg}}`, `{{msg.id}}`)</script>
            <div class="row">
                {% if msg.author == request.user %}
                    <div class="card rounded bg-dark sent-message col-md-12 my-3 content mb-3 float-end" style="width: 18rem;">
                        <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted"><a href="{% url 'profile' msg.author.username %}" class="username card-link">{{msg.author}}</a> {{msg.date}}</h6>
                        <p class="card-text" id="{{msg.id}}"></p>
                        </div>
                    </div>
                {% else %}
                    <div class="card bg-danger content received-message my-3 mb-3 col-md-12 float-start rounded" style="width: 18rem;">
                        <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted"><a href="{% url 'profile' msg.author.username %}" class="username card-link">{{msg.author}}</a> {{msg.date}}</h6>
                        <p class="card-text" id="{{msg.id}}"></p>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    <form method="POST" name="msgform" class="w-75 mx-auto content fixed-bottom">
        {% csrf_token %}
        <div class="input-group mb-3" style="margin: 0 auto;">
            <input type="text" autofocus name="msgcontent" class="form-control form-control-lg" placeholder="Type Your Message" id='contentmsg'>
            <textarea id="encryptedmsgs" name="encryptedmsg" style="display: none;"></textarea>
            <button class="btn btn-primary"  onclick="encmesg()" type="submit" id='sendmsg'><i class="fas fa-paper-plane"></i></button>
        </div>
    </form>
</div>
{% endblock %}