{% extends 'posts/base.html' %}
{% load post_extras %}
{% load static %}
{% block title %}Your Messages On Privalise!, Where Everything Is Awesome{% endblock title %}
{% block content %}
<script src="{% static 'js/libraries/jsencrypt.min.js' %}"></script>
<script src="{% static 'js/libraries/jquery.min.js' %}"></script>
<script src="{% static 'js/libraries/forge.min.js' %}"></script>
<div class="w-100">
    {% for msg in msgs %}
        {{msg.msg}}
    {% endfor %}
</div>
<form method="POST" name="msgform" class="w-100">
    {% csrf_token %}
    <div class="input-group mb-3" style="margin: 0 auto;">
        <input type="text" name="msgcontent" class="form-control form-control-lg" placeholder="Type Your Message" id='contentmsg'>
        <textarea id="encryptedmsg" name="encryptedmsg" style="display: none;"></textarea>
        <button class="btn btn-primary"  type="submit" id='sendmsg'><i class="fas fa-paper-plane"></i></button>
    </div>
</form>
<script type="text/javascript">
    function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
            c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    function decryptkey(password) {
        var pki = forge.pki;
        var privateKey = pki.decryptRsaPrivateKey(`{{privkey}}`, password);
        var pem = pki.privateKeyToPem(privateKey);
        return pem
    }
    var plainprivkey = decryptkey(getCookie('key'));
    var iv = `{{iv}}`;
    var sharedkey = `{{sharedkey}}`;
    var decryptsharedkey = new JSEncrypt();
    decryptsharedkey.setPrivateKey(plainprivkey);
    var uncryptedsharedkey = decryptsharedkey.decrypt(sharedkey);
    var uncryptediv = decryptsharedkey.decrypt(iv);
    $(function() {
        $('#sendmsg').click(function() {
            var key = uncryptedsharedkey;
            //console.log(key);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({iv: uncryptediv});
            cipher.update(forge.util.createBuffer($('#contentmsg').val()));
            cipher.finish();
            var encryptedmsg = cipher.output;
            console.log(encryptedmsg.toHex());
            document.getElementById('encryptedmsg').value = encryptedmsg.toHex();
            
        });
    });
</script>
{% endblock %}